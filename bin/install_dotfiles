#! /usr/bin/env bash

dotfiles=$( cd "$( dirname "${BASH_SOURCE[0]}" )"/.. && pwd )
bashrc=$HOME/.bashrc
src_dir=$(cd "$dotfiles/.." && pwd)

config_folder="$HOME"/.config
[[ -d "$config_folder" ]] || mkdir -p "$config_folder"

function ensure_symlink_exists() {
  local source="$1"
  local target="$2"

  if [[ -L "$target" ]]; then
    echo "Symlink from $source to $target already exists, skipping.."
  else
    echo "Creating symlink from $source to $target"
    ln -sfn "$source" "$target" || exit 1
  fi
}

# Creating symlinks
for file in "$dotfiles"/config/*; do
  link="$config_folder/${file##*/}"
  ensure_symlink_exists "$file" "$link"
done

for file in "$dotfiles"/dotfiles/*; do
  link="$HOME/.${file##*/}"
  ensure_symlink_exists "$file" "$link"
done

if [[ -f $bashrc ]]; then
  mv "$bashrc" "$bashrc.$(date +%s)" || exit 1
  echo "Moved your old ~/.bashrc to ~/.bashrc.bac.[timestamp]"
fi

echo "# Added by install_dotfiles.sh - $(date +"%d/%m/%y %H:%M")" > "$HOME"/.bashrc
for file in "$dotfiles"/bash/*; do
  echo "source $file" >> "$bashrc" || exit 1
done

private_bash="$HOME"/.bash_private

if [[ ! -f "$private_bash" ]]; then
  echo "Creating $private_bash for all your personal needs."
  touch "$private_bash"
else
  echo "$private_bash already exists, skipping.."
fi

echo -e "SRC_DIR=$src_dir\nDOTFILES=$dotfiles" >> "$private_bash" || exit 1
echo "source $private_bash" >> "$bashrc" || exit 1

if [[ -d "$src_dir"/sbp ]];then
  echo "SPB already present, skipping clone.."
  "$src_dir"/sbp/install
else
  echo "Installing SPB"
  git clone git@github.com:brujoand/brujoand/sbp.git "$src_dir"/sbp
  "$src_dir"/sbp/install
fi

if ! grep -q 'source /Users/brujoand/.bashrc' "$HOME/.bash_profile"; then
  echo "Sourcing ~/.bashrc in ~/.profile to handle login shells as well."
  echo "source $HOME/.bashrc" >> "$HOME"/.bash_profile
fi

echo -e "\nReload the shell for changes to take effect"
